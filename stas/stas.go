package stas

import (
	"encoding/hex"
	"fmt"
	"log"
	"regexp"
	"strings"

	"github.com/libsv/go-bt/v2"
	"github.com/libsv/go-bt/v2/bscript"
)

var (
	stasV2 = `OP_DUP OP_HASH160 %x OP_EQUALVERIFY OP_CHECKSIG OP_VERIFY OP_DUP OP_HASH256 OP_16 OP_SPLIT OP_15 OP_SPLIT OP_SWAP OP_14 OP_SPLIT OP_SWAP OP_13 OP_SPLIT OP_SWAP OP_12 OP_SPLIT OP_SWAP OP_11 OP_SPLIT OP_SWAP OP_10 OP_SPLIT OP_SWAP OP_9 OP_SPLIT OP_SWAP OP_8 OP_SPLIT OP_SWAP OP_7 OP_SPLIT OP_SWAP OP_6 OP_SPLIT OP_SWAP OP_5 OP_SPLIT OP_SWAP OP_4 OP_SPLIT OP_SWAP OP_3 OP_SPLIT OP_SWAP OP_2 OP_SPLIT OP_SWAP OP_1 OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_SWAP OP_15 OP_SPLIT OP_SWAP OP_14 OP_SPLIT OP_SWAP OP_13 OP_SPLIT OP_SWAP OP_12 OP_SPLIT OP_SWAP OP_11 OP_SPLIT OP_SWAP OP_10 OP_SPLIT OP_SWAP OP_9 OP_SPLIT OP_SWAP OP_8 OP_SPLIT OP_SWAP OP_7 OP_SPLIT OP_SWAP OP_6 OP_SPLIT OP_SWAP OP_5 OP_SPLIT OP_SWAP OP_4 OP_SPLIT OP_SWAP OP_3 OP_SPLIT OP_SWAP OP_2 OP_SPLIT OP_SWAP OP_1 OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT 00 OP_CAT OP_BIN2NUM OP_1ADD 414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00 OP_TUCK OP_MOD OP_2DUP OP_SWAP OP_2 OP_DIV OP_GREATERTHAN OP_IF OP_SUB OP_ELSE OP_NIP OP_ENDIF OP_SIZE OP_DUP 24 OP_ADD 30 OP_SWAP OP_CAT 022079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179802 OP_CAT OP_SWAP OP_CAT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT 41 OP_CAT 038ff83d8cf12121491609c4939dc11c4aa35503508fe432dc5a5c1905608b9218 OP_CHECKSIGVERIFY OP_4 OP_SPLIT OP_NIP 20 OP_SPLIT 20 OP_SPLIT OP_NIP 24 OP_SPLIT OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM OP_SPLIT OP_2SWAP OP_CAT OP_ROT 17 OP_SPLIT OP_NIP OP_ROT OP_5 OP_ROLL OP_DUP OP_NOTIF OP_2ROT OP_6 OP_ROLL OP_7 OP_ROLL OP_OVER OP_IF OP_4 OP_NUM2BIN OP_CAT OP_CAT OP_ELSE OP_2DROP OP_ENDIF OP_HASH256 OP_EQUALVERIFY OP_0 OP_ELSE OP_DUP OP_1 OP_8 OP_WITHIN OP_VERIFY OP_DUP OP_1 OP_EQUAL OP_NOTIF OP_2 OP_SUB OP_6 OP_ROLL OP_3 OP_PICK OP_8 OP_ROLL OP_CAT OP_CAT OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_ELSE OP_6 OP_ROLL OP_ENDIF OP_DUP OP_HASH256 OP_8 OP_ROLL OP_TUCK OP_4 OP_NUM2BIN OP_CAT OP_7 OP_ROLL OP_9 OP_ROLL OP_10 OP_ROLL OP_OVER OP_IF OP_4 OP_NUM2BIN OP_CAT OP_3DUP OP_CAT OP_CAT OP_HASH256 OP_2SWAP OP_SWAP OP_CAT OP_ELSE OP_2DROP OP_2DUP OP_CAT OP_HASH256 OP_SWAP OP_ENDIF OP_ROT OP_CAT OP_HASH256 OP_8 OP_ROLL OP_TUCK OP_EQUAL OP_DUP OP_IF OP_1 OP_ELSE OP_2 OP_ENDIF OP_SWAP OP_2SWAP OP_EQUAL OP_BOOLOR OP_VERIFY OP_3 OP_ROLL OP_NOTIF OP_DROP OP_0 OP_ENDIF OP_SWAP OP_ROT OP_4 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER OP_3 OP_GREATERTHAN OP_NOT OP_VERIFY 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_4 OP_ADD OP_SPLIT OP_NIP OP_OVER OP_1SUB OP_IF 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_4 OP_ADD OP_SPLIT OP_NIP OP_OVER OP_2 OP_SUB OP_IF 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_4 OP_ADD OP_SPLIT OP_NIP OP_ENDIF OP_ENDIF OP_NIP OP_1 OP_SPLIT OP_SWAP OP_2 OP_PICK OP_TUCK OP_1ADD OP_LESSTHAN OP_SWAP OP_3 OP_GREATERTHAN OP_BOOLOR OP_NOT OP_VERIFY OP_SWAP OP_DUP OP_IF OP_1SUB OP_SWAP OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_SPLIT OP_NIP OP_SWAP OP_ENDIF OP_DUP OP_IF OP_1SUB OP_SWAP OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_SPLIT OP_NIP OP_SWAP OP_ENDIF OP_IF OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_SPLIT OP_NIP OP_ENDIF OP_8 OP_SPLIT OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM OP_2SWAP OP_CAT OP_ROT OP_ROT OP_ENDIF OP_SPLIT OP_DROP OP_3 OP_SPLIT OP_SWAP 76a914 OP_EQUALVERIFY 14 OP_SPLIT OP_NIP OP_3 OP_PICK OP_NOTIF OP_5 OP_PICK OP_EQUALVERIFY OP_DROP OP_ELSE OP_2SWAP OP_ENDIF OP_BIN2NUM OP_DUP OP_VERIFY OP_ENDIF OP_OVER OP_0NOTEQUAL OP_IF OP_5 OP_ELSE OP_3 OP_ENDIF OP_ROLL OP_DUP 6c05 OP_SPLIT OP_NIP 14 OP_SPLIT OP_SIZE OP_IF OP_1 OP_SPLIT OP_SWAP OP_DUP OP_IF 00 OP_CAT OP_BIN2NUM OP_SPLIT OP_SWAP OP_ELSE OP_DROP OP_FALSE OP_ENDIF OP_NIP OP_ENDIF OP_TOALTSTACK OP_3 OP_PICK OP_0NOTEQUAL OP_IF OP_3 OP_PICK OP_2 OP_EQUAL OP_IF OP_4 OP_ROLL OP_TOALTSTACK OP_4 OP_ROLL OP_TOALTSTACK OP_ELSE OP_SWAP OP_TOALTSTACK OP_6 OP_ROLL OP_TOALTSTACK OP_3 OP_ROLL OP_SWAP OP_2ROT OP_SWAP OP_2ROT OP_2ROT OP_ENDIF OP_ENDIF OP_4 OP_ROLL OP_8 OP_SPLIT OP_SWAP OP_BIN2NUM OP_4 OP_ROLL OP_5 OP_PICK OP_NOTIF OP_ADD OP_ELSE OP_5 OP_PICK OP_1 OP_EQUAL OP_IF OP_SWAP OP_ENDIF OP_TOALTSTACK OP_ENDIF OP_SWAP OP_4 OP_SPLIT OP_NIP 20 OP_SPLIT OP_DROP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_DUP OP_8 OP_NUM2BIN OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_6 OP_ROLL OP_EQUAL OP_NOTIF OP_7 OP_PICK 76a914 OP_CAT OP_SWAP OP_CAT OP_5 OP_PICK OP_ELSE 1976a914 OP_SWAP OP_CAT 88ac OP_ENDIF OP_CAT OP_CAT OP_5 OP_PICK OP_IF OP_FROMALTSTACK OP_DUP OP_VERIFY OP_DUP OP_DEPTH OP_1SUB OP_ROLL OP_NUMEQUALVERIFY OP_8 OP_NUM2BIN OP_CAT OP_FROMALTSTACK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_FROMALTSTACK OP_CAT OP_CAT OP_ELSE OP_FROMALTSTACK OP_DUP OP_TOALTSTACK OP_SIZE OP_IF OP_SIZE OP_1SUB OP_0 OP_SWAP OP_NUM2BIN OP_1 OP_CAT OP_AND OP_ENDIF OP_NOTIF OP_DEPTH OP_10 OP_GREATERTHAN OP_IF OP_SWAP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_TUCK OP_ADD OP_ROT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_6 OP_PICK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_ENDIF OP_ENDIF OP_ENDIF OP_FROMALTSTACK OP_6 OP_ROLL OP_1 OP_EQUAL OP_IF OP_DROP OP_FALSE OP_ELSE OP_SIZE OP_IF OP_SIZE OP_1SUB OP_0 OP_SWAP OP_NUM2BIN OP_1 OP_CAT OP_AND OP_ENDIF OP_ENDIF OP_NOTIF OP_DEPTH OP_9 OP_GREATERTHAN OP_IF OP_SWAP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_TUCK OP_ADD OP_ROT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_5 OP_PICK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_ENDIF OP_DEPTH OP_9 OP_GREATERTHAN OP_IF OP_SWAP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_TUCK OP_ADD OP_ROT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_5 OP_PICK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_ENDIF OP_ENDIF OP_SWAP OP_3 OP_ROLL OP_NUMEQUALVERIFY OP_4 OP_PICK OP_IF OP_5 OP_PICK OP_8 OP_NUM2BIN OP_CAT 1976a914 OP_5 OP_PICK OP_CAT 88ac OP_CAT OP_CAT OP_ENDIF OP_HASH256 OP_EQUAL OP_2SWAP OP_2DROP OP_NIP OP_NIP OP_RETURN %x`
	// in the flags field 0x01=unsplittable (NFT), 0x00=splittable
	//             OP_DUP OP_HASH160 <owner address - 20 bytes> OP_EQUALVERIFY OP_CHECKSIG OP_VERIFY OP_DUP OP_HASH256 OP_16 OP_SPLIT OP_15 OP_SPLIT OP_SWAP OP_14 OP_SPLIT OP_SWAP OP_13 OP_SPLIT OP_SWAP OP_12 OP_SPLIT OP_SWAP OP_11 OP_SPLIT OP_SWAP OP_10 OP_SPLIT OP_SWAP OP_9 OP_SPLIT OP_SWAP OP_8 OP_SPLIT OP_SWAP OP_7 OP_SPLIT OP_SWAP OP_6 OP_SPLIT OP_SWAP OP_5 OP_SPLIT OP_SWAP OP_4 OP_SPLIT OP_SWAP OP_3 OP_SPLIT OP_SWAP OP_2 OP_SPLIT OP_SWAP OP_1 OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_SWAP OP_15 OP_SPLIT OP_SWAP OP_14 OP_SPLIT OP_SWAP OP_13 OP_SPLIT OP_SWAP OP_12 OP_SPLIT OP_SWAP OP_11 OP_SPLIT OP_SWAP OP_10 OP_SPLIT OP_SWAP OP_9 OP_SPLIT OP_SWAP OP_8 OP_SPLIT OP_SWAP OP_7 OP_SPLIT OP_SWAP OP_6 OP_SPLIT OP_SWAP OP_5 OP_SPLIT OP_SWAP OP_4 OP_SPLIT OP_SWAP OP_3 OP_SPLIT OP_SWAP OP_2 OP_SPLIT OP_SWAP OP_1 OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT 00 OP_CAT OP_BIN2NUM OP_1ADD 414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00 OP_TUCK OP_MOD OP_2DUP OP_SWAP OP_2 OP_DIV OP_GREATERTHAN OP_IF OP_SUB OP_ELSE OP_NIP OP_ENDIF OP_SIZE OP_DUP 24 OP_ADD 30 OP_SWAP OP_CAT 022079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179802 OP_CAT OP_SWAP OP_CAT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT 41 OP_CAT 038ff83d8cf12121491609c4939dc11c4aa35503508fe432dc5a5c1905608b9218 OP_CHECKSIGVERIFY OP_4 OP_SPLIT OP_NIP 20 OP_SPLIT 20 OP_SPLIT OP_NIP 24 OP_SPLIT OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM OP_SPLIT OP_2SWAP OP_CAT OP_ROT 17 OP_SPLIT OP_NIP OP_ROT OP_5 OP_ROLL OP_DUP OP_NOTIF OP_2ROT OP_6 OP_ROLL OP_7 OP_ROLL OP_OVER OP_IF OP_4 OP_NUM2BIN OP_CAT OP_CAT OP_ELSE OP_2DROP OP_ENDIF OP_HASH256 OP_EQUALVERIFY OP_0 OP_ELSE OP_DUP OP_1 OP_8 OP_WITHIN OP_VERIFY OP_DUP OP_1 OP_EQUAL OP_NOTIF OP_2 OP_SUB OP_6 OP_ROLL OP_3 OP_PICK OP_8 OP_ROLL OP_CAT OP_CAT OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_OVER OP_IF OP_SWAP OP_1SUB OP_SWAP OP_3 OP_PICK OP_CAT OP_7 OP_ROLL OP_CAT OP_ENDIF OP_ELSE OP_6 OP_ROLL OP_ENDIF OP_DUP OP_HASH256 OP_8 OP_ROLL OP_TUCK OP_4 OP_NUM2BIN OP_CAT OP_7 OP_ROLL OP_9 OP_ROLL OP_10 OP_ROLL OP_OVER OP_IF OP_4 OP_NUM2BIN OP_CAT OP_3DUP OP_CAT OP_CAT OP_HASH256 OP_2SWAP OP_SWAP OP_CAT OP_ELSE OP_2DROP OP_2DUP OP_CAT OP_HASH256 OP_SWAP OP_ENDIF OP_ROT OP_CAT OP_HASH256 OP_8 OP_ROLL OP_TUCK OP_EQUAL OP_DUP OP_IF OP_1 OP_ELSE OP_2 OP_ENDIF OP_SWAP OP_2SWAP OP_EQUAL OP_BOOLOR OP_VERIFY OP_3 OP_ROLL OP_NOTIF OP_DROP OP_0 OP_ENDIF OP_SWAP OP_ROT OP_4 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER OP_3 OP_GREATERTHAN OP_NOT OP_VERIFY 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_4 OP_ADD OP_SPLIT OP_NIP OP_OVER OP_1SUB OP_IF 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_4 OP_ADD OP_SPLIT OP_NIP OP_OVER OP_2 OP_SUB OP_IF 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_4 OP_ADD OP_SPLIT OP_NIP OP_ENDIF OP_ENDIF OP_NIP OP_1 OP_SPLIT OP_SWAP OP_2 OP_PICK OP_TUCK OP_1ADD OP_LESSTHAN OP_SWAP OP_3 OP_GREATERTHAN OP_BOOLOR OP_NOT OP_VERIFY OP_SWAP OP_DUP OP_IF OP_1SUB OP_SWAP OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_SPLIT OP_NIP OP_SWAP OP_ENDIF OP_DUP OP_IF OP_1SUB OP_SWAP OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_SPLIT OP_NIP OP_SWAP OP_ENDIF OP_IF OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_SWAP 00 OP_CAT OP_BIN2NUM OP_ENDIF OP_SPLIT OP_NIP OP_ENDIF OP_8 OP_SPLIT OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM OP_DUP FC00 OP_GREATERTHAN OP_IF FD00 OP_GREATERTHAN OP_IF OP_4 OP_ELSE OP_2 OP_ENDIF OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM OP_2SWAP OP_CAT OP_ROT OP_ROT OP_ENDIF OP_SPLIT OP_DROP OP_3 OP_SPLIT OP_SWAP 76a914 OP_EQUALVERIFY 14 OP_SPLIT OP_NIP OP_3 OP_PICK OP_NOTIF OP_5 OP_PICK OP_EQUALVERIFY OP_DROP OP_ELSE OP_2SWAP OP_ENDIF OP_BIN2NUM OP_DUP OP_VERIFY OP_ENDIF OP_OVER OP_0NOTEQUAL OP_IF OP_5 OP_ELSE OP_3 OP_ENDIF OP_ROLL OP_DUP 6c05 OP_SPLIT OP_NIP 14 OP_SPLIT OP_SIZE OP_IF OP_1 OP_SPLIT OP_SWAP OP_DUP OP_IF 00 OP_CAT OP_BIN2NUM OP_SPLIT OP_SWAP OP_ELSE OP_DROP OP_FALSE OP_ENDIF OP_NIP OP_ENDIF OP_TOALTSTACK OP_3 OP_PICK OP_0NOTEQUAL OP_IF OP_3 OP_PICK OP_2 OP_EQUAL OP_IF OP_4 OP_ROLL OP_TOALTSTACK OP_4 OP_ROLL OP_TOALTSTACK OP_ELSE OP_SWAP OP_TOALTSTACK OP_6 OP_ROLL OP_TOALTSTACK OP_3 OP_ROLL OP_SWAP OP_2ROT OP_SWAP OP_2ROT OP_2ROT OP_ENDIF OP_ENDIF OP_4 OP_ROLL OP_8 OP_SPLIT OP_SWAP OP_BIN2NUM OP_4 OP_ROLL OP_5 OP_PICK OP_NOTIF OP_ADD OP_ELSE OP_5 OP_PICK OP_1 OP_EQUAL OP_IF OP_SWAP OP_ENDIF OP_TOALTSTACK OP_ENDIF OP_SWAP OP_4 OP_SPLIT OP_NIP 20 OP_SPLIT OP_DROP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_DUP OP_8 OP_NUM2BIN OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_6 OP_ROLL OP_EQUAL OP_NOTIF OP_7 OP_PICK 76a914 OP_CAT OP_SWAP OP_CAT OP_5 OP_PICK OP_ELSE 1976a914 OP_SWAP OP_CAT 88ac OP_ENDIF OP_CAT OP_CAT OP_5 OP_PICK OP_IF OP_FROMALTSTACK OP_DUP OP_VERIFY OP_DUP OP_DEPTH OP_1SUB OP_ROLL OP_NUMEQUALVERIFY OP_8 OP_NUM2BIN OP_CAT OP_FROMALTSTACK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_FROMALTSTACK OP_CAT OP_CAT OP_ELSE OP_FROMALTSTACK OP_DUP OP_TOALTSTACK OP_SIZE OP_IF OP_SIZE OP_1SUB OP_0 OP_SWAP OP_NUM2BIN OP_1 OP_CAT OP_AND OP_ENDIF OP_NOTIF OP_DEPTH OP_10 OP_GREATERTHAN OP_IF OP_SWAP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_TUCK OP_ADD OP_ROT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_6 OP_PICK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_ENDIF OP_ENDIF OP_ENDIF OP_FROMALTSTACK OP_6 OP_ROLL OP_1 OP_EQUAL OP_IF OP_DROP OP_FALSE OP_ELSE OP_SIZE OP_IF OP_SIZE OP_1SUB OP_0 OP_SWAP OP_NUM2BIN OP_1 OP_CAT OP_AND OP_ENDIF OP_ENDIF OP_NOTIF OP_DEPTH OP_9 OP_GREATERTHAN OP_IF OP_SWAP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_TUCK OP_ADD OP_ROT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_5 OP_PICK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_ENDIF OP_DEPTH OP_9 OP_GREATERTHAN OP_IF OP_SWAP OP_DEPTH OP_1SUB OP_ROLL OP_DUP OP_VERIFY OP_TUCK OP_ADD OP_ROT OP_ROT OP_8 OP_NUM2BIN OP_CAT OP_5 OP_PICK 76a914 OP_CAT OP_DEPTH OP_1SUB OP_ROLL OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_ENDIF OP_ENDIF OP_SWAP OP_3 OP_ROLL OP_NUMEQUALVERIFY OP_4 OP_PICK OP_IF OP_5 OP_PICK OP_8 OP_NUM2BIN OP_CAT 1976a914 OP_5 OP_PICK OP_CAT 88ac OP_CAT OP_CAT OP_ENDIF OP_HASH256 OP_EQUAL OP_2SWAP OP_2DROP OP_NIP OP_NIP OP_RETURN <"redemption address"/"protocol ID" - 20 bytes> <flags field - upto 255B length> <optional data field/s - upto around 4.2GB size>
	// stasV2      = `OP_DUP OP_HASH160 %x OP_EQUALVERIFY OP_CHECKSIG OP_VERIFY OP_DUP OP_HASH256 OP_16 OP_SPLIT OP_15 OP_SPLIT OP_SWAP OP_14 OP_SPLIT OP_SWAP OP_13 OP_SPLIT OP_SWAP OP_12 OP_SPLIT OP_SWAP OP_11 OP_SPLIT OP_SWAP OP_10 OP_SPLIT OP_SWAP OP_9 OP_SPLIT OP_SWAP OP_8 OP_SPLIT OP_SWAP OP_7 OP_SPLIT OP_SWAP OP_6 OP_SPLIT OP_SWAP OP_5 OP_SPLIT OP_SWAP OP_4 OP_SPLIT OP_SWAP OP_3 OP_SPLIT OP_SWAP OP_2 OP_SPLIT OP_SWAP OP_1 OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_SWAP OP_15 OP_SPLIT OP_SWAP OP_14 OP_SPLIT OP_SWAP OP_13 OP_SPLIT OP_SWAP OP_12 OP_SPLIT OP_SWAP OP_11 OP_SPLIT OP_SWAP OP_10 OP_SPLIT OP_SWAP OP_9 OP_SPLIT OP_SWAP OP_8 OP_SPLIT OP_SWAP OP_7 OP_SPLIT OP_SWAP OP_6 OP_SPLIT OP_SWAP OP_5 OP_SPLIT OP_SWAP OP_4 OP_SPLIT OP_SWAP OP_3 OP_SPLIT OP_SWAP OP_2 OP_SPLIT OP_SWAP OP_1 OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT 00 OP_CAT OP_BIN2NUM OP_1ADD 414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff00 OP_TUCK OP_MOD OP_2DUP OP_SWAP OP_2 OP_DIV OP_GREATERTHAN OP_IF OP_SUB OP_ELSE OP_NIP OP_ENDIF OP_SIZE OP_DUP 24 OP_ADD 30 OP_SWAP OP_CAT 022079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179802 OP_CAT OP_SWAP OP_CAT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_SIZE OP_DUP OP_IF OP_1SUB OP_ENDIF OP_SPLIT OP_SWAP OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT OP_CAT 41 OP_CAT 038ff83d8cf12121491609c4939dc11c4aa35503508fe432dc5a5c1905608b9218 OP_CHECKSIGVERIFY OP_4 OP_SPLIT OP_NIP 20 OP_SPLIT 20 OP_SPLIT OP_NIP 24 OP_SPLIT 1a OP_SPLIT OP_NIP c703 OP_SPLIT OP_4 OP_ROLL OP_DUP OP_NOTIF OP_DROP OP_2SWAP OP_2DROP OP_0 OP_ELSE OP_DUP OP_2 OP_6 OP_WITHIN OP_VERIFY OP_1SUB OP_TOALTSTACK OP_2ROT OP_3 OP_PICK OP_CAT OP_SWAP OP_CAT OP_FROMALTSTACK OP_1SUB OP_DUP OP_IF OP_TOALTSTACK OP_5 OP_ROLL OP_3 OP_PICK OP_SWAP OP_CAT OP_CAT OP_FROMALTSTACK OP_1SUB OP_DUP OP_IF OP_TOALTSTACK OP_5 OP_ROLL OP_3 OP_PICK OP_SWAP OP_CAT OP_CAT OP_FROMALTSTACK OP_1SUB OP_DUP OP_IF OP_TOALTSTACK OP_5 OP_ROLL OP_3 OP_PICK OP_SWAP OP_CAT OP_CAT OP_FROMALTSTACK OP_ENDIF OP_ENDIF OP_ENDIF OP_DROP OP_DUP OP_HASH256 OP_6 OP_ROLL OP_TUCK OP_4 OP_NUM2BIN OP_CAT OP_5 OP_ROLL OP_7 OP_ROLL OP_8 OP_ROLL OP_4 OP_NUM2BIN OP_CAT OP_3DUP OP_CAT OP_CAT OP_HASH256 OP_2SWAP OP_SWAP OP_CAT OP_ROT OP_CAT OP_HASH256 OP_6 OP_ROLL OP_TUCK OP_EQUAL OP_SWAP OP_ROT OP_EQUAL OP_BOOLOR OP_VERIFY OP_SWAP OP_4 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER OP_3 OP_GREATERTHAN OP_NOT OP_VERIFY 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FC00 OP_GREATERTHAN OP_IF OP_SWAP OP_DROP OP_2 OP_SPLIT OP_ENDIF OP_SWAP OP_4 OP_ADD OP_SPLIT OP_NIP OP_OVER OP_1SUB OP_IF 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FC00 OP_GREATERTHAN OP_IF OP_SWAP OP_DROP OP_2 OP_SPLIT OP_ENDIF OP_SWAP OP_4 OP_ADD OP_SPLIT OP_NIP OP_OVER OP_2 OP_SUB OP_IF 24 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FC00 OP_GREATERTHAN OP_IF OP_SWAP OP_DROP OP_2 OP_SPLIT OP_ENDIF OP_SWAP OP_4 OP_ADD OP_SPLIT OP_NIP OP_ENDIF OP_ENDIF OP_SWAP OP_DROP OP_1 OP_SPLIT OP_SWAP OP_2 OP_PICK OP_TUCK OP_1ADD OP_LESSTHAN OP_SWAP OP_1 OP_GREATERTHAN OP_BOOLOR OP_NOT OP_VERIFY OP_SWAP OP_IF OP_8 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FC00 OP_GREATERTHAN OP_IF OP_SWAP OP_DROP OP_2 OP_SPLIT OP_ENDIF OP_SWAP OP_SPLIT OP_NIP OP_ENDIF OP_8 OP_SPLIT OP_1 OP_SPLIT OP_OVER 00 OP_CAT OP_BIN2NUM FC00 OP_GREATERTHAN OP_IF OP_SWAP OP_DROP OP_2 OP_SPLIT OP_ENDIF OP_SWAP OP_SPLIT OP_DROP OP_3 OP_SPLIT OP_SWAP 76a914 OP_EQUALVERIFY 14 OP_SPLIT OP_NIP OP_3 OP_PICK OP_EQUALVERIFY OP_BIN2NUM OP_ENDIF OP_ROT OP_DUP b303 OP_SPLIT OP_NIP OP_3 OP_ROLL OP_8 OP_SPLIT OP_SWAP OP_BIN2NUM OP_4 OP_ROLL OP_ADD OP_SWAP OP_4 OP_SPLIT OP_NIP 20 OP_SPLIT OP_DROP OP_9 OP_ROLL OP_DUP OP_8 OP_NUM2BIN OP_10 OP_ROLL OP_DUP OP_6 OP_ROLL OP_EQUAL OP_NOTIF fdde03 76a914 OP_CAT OP_SWAP OP_CAT OP_5 OP_PICK OP_CAT OP_ELSE 1976a914 OP_SWAP OP_CAT 88ac OP_CAT OP_ENDIF OP_CAT OP_7 OP_PICK OP_IF OP_8 OP_PICK OP_8 OP_NUM2BIN OP_CAT fdde03 76a914 OP_CAT OP_8 OP_PICK OP_CAT OP_5 OP_PICK OP_CAT OP_CAT OP_3 OP_ROLL OP_ROT OP_8 OP_PICK OP_ADD OP_NUMEQUALVERIFY OP_ELSE OP_3 OP_ROLL OP_ROT OP_NUMEQUALVERIFY OP_ENDIF OP_3 OP_PICK OP_IF OP_4 OP_PICK OP_8 OP_NUM2BIN OP_CAT 1976a914 OP_4 OP_PICK OP_CAT 88ac OP_CAT OP_CAT OP_ENDIF OP_HASH256 OP_EQUAL OP_2ROT OP_2DROP OP_2SWAP OP_2DROP OP_NIP OP_RETURN %x`
	// OP_RETURN <"redemption address"/"protocol ID" - 20 bytes> <flags field - upto 255B length> <optional data field/s - upto around 4.2GB size>

	// group 1: isSplittable flag, group 2: symbol, group 3: data
	stasV2Data = "OP_RETURN [0-9a-fA-F]{40} (?P<flags>(?i:(OP_DATA_1)|(OP_FALSE)))(?P<symbol>([\\s]?[\\S]*[\\s]?))(?P<data>[a-f0-9]*)+$"

	stasV2Regex           *regexp.Regexp
	stasScriptV2DataRegex *regexp.Regexp
)

func init() {
	markerStr := "0011223344556677889900112233445566778899"
	marker, _ := hex.DecodeString(markerStr)

	stasScriptV2DataRegex = regexp.MustCompile(stasV2Data)

	asmScript2 := fmt.Sprintf(stasV2, marker, marker)
	// TODO needs to be dynamically set to 00 or 01
	script2, _ := bscript.NewFromASM(asmScript2 + " 00")
	stasV2RegexStr := "^" + strings.ReplaceAll(script2.String(), markerStr, "[0-9a-fA-F]{40}") + ".*$"
	i := strings.LastIndex(stasV2RegexStr, "00")
	stasV2RegexStr = stasV2RegexStr[:i] + strings.Replace(stasV2RegexStr[i:], "00", "[0-9a-fA-F]{2}", 1)
	stasV2Regex = regexp.MustCompile(stasV2RegexStr)
}

// getDataFromScript if any exists.
func getDataFromScript(script bscript.Script, version int) *string {
	asm, err := script.ToASM()
	if err != nil {
		log.Printf("error decoding script: %v", err)
		return nil
	}

	if version == 2 {
		match := stasScriptV2DataRegex.FindStringSubmatch(asm)
		matchCount := len(match)

		if matchCount > 1 {
			data := match[matchCount-1]
			// log.Printf("flags: %s", match[1])
			// log.Printf("data: %s", data)
			bs, err := hex.DecodeString(data)
			if err != nil {
				log.Printf("error decoding data: %v", err)
				return nil
			}
			str := string(bs)
			return &str
		}
		return nil
	}
	return nil
}

// get flags from script. Only for version 2
func getFlagsFromScript(script *bscript.Script) *string {
	asm, err := script.ToASM()
	if err != nil {
		log.Printf("error decoding script: %v", err)
		return nil
	}

	match := stasScriptV2DataRegex.FindStringSubmatch(asm)

	matchCount := len(match)
	if matchCount > 1 {
		data := match[1]

		// return &data
		bs, err := bscript.NewFromASM(data)
		if err != nil {
			log.Printf("error decoding data: %v", err)
			return nil
		}

		s := bs.String()
		return &s
	}
	return nil
}

// is the splittable flag set. Default is true.
func IsSplittable(o *bt.Output) bool {
	isSplittable := true
	flags := getFlagsFromScript(o.LockingScript)
	if flags == nil {
		log.Println("flags is nil")
		return isSplittable
	}

	if *flags == "01" {
		isSplittable = false
	}

	return isSplittable
}

// GetVersion returns the sSTAS protocol version for a given Output
func GetVersion(output *bt.Output) int {
	// https://github.com/TAAL-GmbH/stas-go.git

	script, err := output.LockingScript.ToASM()
	if err != nil {
		return 0
	}

	// if stasV1Regex.MatchString(script) {
	// 	return 1
	// }
	log.Printf("Script Hex: %s\n\n", output.LockingScript.String())

	if stasV2Regex.MatchString(output.LockingScript.String()) {
		log.Println("Match!", script)
		return 2
	}
	log.Println("No regex match", stasV2Regex.String())

	return 0

}

func createStasOutput(destination string) (stasOut bt.Output, err error) {
	return stasOut, nil
}
